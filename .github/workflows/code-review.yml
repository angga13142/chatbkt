name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.js'
      - '**.json'
      - '**.md'

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: GitHub Copilot Code Review
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run syntax check
        run: |
          echo "üîç Checking JavaScript syntax..."
          for file in *.js lib/*.js; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              node --check "$file" || exit 1
            fi
          done

      - name: Check code style
        run: |
          echo "üìã Checking for common issues..."
          
          # Check for console.log in production code (except index.js)
          if grep -n "console.log" chatbotLogic.js lib/*.js 2>/dev/null | grep -v "// TODO:" | grep -v "// DEBUG:"; then
            echo "‚ö†Ô∏è  Warning: Found console.log in production code"
          fi
          
          # Check for hardcoded credentials
          if grep -rn "sk_.*_secret\|xnd_.*_test\|password.*=" --include="*.js" --exclude="*.example.js" .; then
            echo "‚ùå Error: Possible hardcoded credentials found"
            exit 1
          fi
          
          # Check for TODO/FIXME
          echo "üìù Found TODOs/FIXMEs:"
          grep -rn "TODO\|FIXME" --include="*.js" . || echo "None"

      - name: Security audit
        run: |
          echo "üîí Running security audit..."
          npm audit --audit-level=moderate || true

      - name: Request Copilot Review
        uses: github/copilot-code-review-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-type: 'full'
          focus-areas: |
            - Security vulnerabilities
            - Payment handling logic
            - Session management
            - Rate limiting effectiveness
            - Input validation
            - Error handling
            - Memory leaks
            - Best practices for WhatsApp bot
          
      - name: Comment summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = `## ü§ñ Code Review Summary
            
            ‚úÖ Syntax check completed
            ‚úÖ Style guidelines verified
            ‚úÖ Security audit completed
            
            **Review Focus:**
            - Payment processing & Xendit integration
            - Session & state management
            - Security (rate limiting, validation, logging)
            - WhatsApp bot patterns
            
            **Key Files:**
            - \`chatbotLogic.js\` - Business logic & state machine
            - \`lib/paymentHandlers.js\` - Payment processing
            - \`lib/inputValidator.js\` - Security & validation
            - \`sessionManager.js\` - Session storage
            
            See detailed review comments below. üëá`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
